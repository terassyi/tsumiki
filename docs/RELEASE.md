# Release Process

This document describes the release workflow for tsumiki.

## Overview

tsumiki uses [release-plz](https://release-plz.ieni.dev/) for automated releases. The release process is triggered manually via GitHub Actions.

### Release Flow

1. Run release-plz workflow (workflow_dispatch)
2. Tests run (test, e2e-test, rustls-integration-test)
3. Cargo.lock freshness check
4. release-plz creates a Release PR
5. Review and merge the Release PR
6. release-plz publishes crates to crates.io
7. (For tsumiki-cli) Tag triggers binary build and GitHub Release

## Workflows

### release-plz.yml

The main release workflow. It can be triggered in two ways:

1. **Manual trigger (workflow_dispatch)**: Creates a Release PR
2. **Release PR merge**: Publishes crates to crates.io

#### Dry Run

To test the release without making changes:

1. Go to Actions > Release-plz
2. Click "Run workflow"
3. Check "Dry run" option
4. Click "Run workflow"

This runs `release-plz update` without creating a PR or publishing.

#### Creating a Release

1. Go to Actions > Release-plz
2. Click "Run workflow"
3. Leave "Dry run" unchecked
4. Click "Run workflow"

This creates a Release PR with:
- Version bumps based on conventional commits
- Updated CHANGELOG files

### release.yml

Triggered when a `tsumiki-cli-vX.Y.Z` tag is pushed (by release-plz). This workflow:

1. Runs all tests
2. Builds binaries for:
   - Linux x86_64 (musl)
   - Linux arm64 (musl)
   - macOS arm64
3. Creates a GitHub Release with binary assets

### cargo-update.yml

Weekly workflow (Sunday 00:00 UTC) that runs `cargo update` and creates a PR if dependencies changed.

## Conventional Commits

Version bumps are determined by [conventional commits](https://www.conventionalcommits.org/):

| Commit Type | Version Bump |
|-------------|--------------|
| `feat:` | Minor (0.x.0) |
| `fix:` | Patch (0.0.x) |
| `BREAKING CHANGE:` | Major (x.0.0) |
| `docs:`, `chore:`, etc. | Patch |

### PR Title Format

PR titles must follow the conventional commit format:

```
<type>(<scope>): <description>
```

Examples:
- `feat(x509): add certificate chain validation`
- `fix(der): handle invalid tag encoding`
- `docs: update README`

Valid types: `feat`, `fix`, `docs`, `style`, `refactor`, `perf`, `test`, `build`, `ci`, `chore`, `revert`

Valid scopes: `tsumiki`, `pem`, `der`, `asn1`, `pkix-types`, `x509`, `pkcs`, `cli`

## Package Configuration

See `.github/release-plz.toml` for package-specific settings:

| Package | Published | Git Tag | Notes |
|---------|-----------|---------|-------|
| `tsumiki` | Yes | Yes | Core traits |
| `tsumiki-pem` | Yes | Yes | |
| `tsumiki-der` | Yes | Yes | |
| `tsumiki-asn1` | Yes | Yes | |
| `tsumiki-pkix-types` | Yes | Yes | |
| `tsumiki-x509` | Yes | Yes | |
| `tsumiki-pkcs` | Yes | Yes | |
| `tsumiki-cli` | Yes | Yes (triggers binary release) | |
| `examples` | No | No | Not published |

## Changelog

Changelogs are generated by [git-cliff](https://git-cliff.org/) using `.github/cliff.toml`. Each crate has its own CHANGELOG.md file.

## Secrets Required

The following secrets must be configured in GitHub repository settings:

| Secret | Description |
|--------|-------------|
| `CARGO_REGISTRY_TOKEN` | Token for publishing to crates.io |
| `GITHUB_TOKEN` | Provided automatically by GitHub Actions |

## Troubleshooting

### Release PR Not Created

1. Check that tests pass
2. Check that `cargo update` has no pending changes
3. Check workflow logs for errors

### Crate Not Published

1. Ensure `CARGO_REGISTRY_TOKEN` is set
2. Check that version number is not already published
3. Check release-plz logs for errors

### Binary Build Failed

1. Check that the tag format matches `tsumiki-cli-vX.Y.Z`
2. Check build logs for compilation errors
